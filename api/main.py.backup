from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from supabase import Client
from uuid import UUID
from typing import List

from api.database import get_supabase
from api.dependencies import get_current_user
from api.models import ItemCreateRequest, ItemResponse, ErrorResponse

app = FastAPI(
    title="Grocery List MVP",
    description="Zero-friction grocery list management",
    version="1.0.0"
)

# CORS middleware for frontend
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Configure for production
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.get("/")
async def root():
    """Health check endpoint"""
    return {"status": "ok", "service": "grocery-list-mvp"}


@app.get("/api/items", response_model=List[ItemResponse])
async def get_items(
    user_id: str = Depends(get_current_user),
    supabase: Client = Depends(get_supabase)
):
    """
    Get all grocery items for the authenticated user.
    Returns both bought and unbought items.
    """
    try:
        response = supabase.table("grocery_items") \
            .select("*") \
            .eq("user_id", user_id) \
            .order("created_at") \
            .execute()
        
        return response.data
    
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to fetch items: {str(e)}"
        )


@app.post("/api/items", response_model=ItemResponse, status_code=status.HTTP_201_CREATED)
async def create_item(
    item: ItemCreateRequest,
    user_id: str = Depends(get_current_user),
    supabase: Client = Depends(get_supabase)
):
    """
    Create a new grocery item.
    Item is created with is_bought=false by default.
    """
    try:
        response = supabase.table("grocery_items") \
            .insert({
                "user_id": user_id,
                "name": item.name,
                "is_bought": False
            }) \
            .execute()
        
        if not response.data:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="Failed to create item"
            )
        
        return response.data[0]
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to create item: {str(e)}"
        )


@app.patch("/api/items/{item_id}/toggle", response_model=ItemResponse)
async def toggle_item(
    item_id: UUID,
    user_id: str = Depends(get_current_user),
    supabase: Client = Depends(get_supabase)
):
    """
    Toggle the is_bought status of a grocery item.
    Flips between bought/unbought state.
    """
    try:
        # First, get the current item to check ownership and get current state
        item_response = supabase.table("grocery_items") \
            .select("*") \
            .eq("item_id", str(item_id)) \
            .eq("user_id", user_id) \
            .execute()
        
        if not item_response.data:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Item not found"
            )
        
        current_item = item_response.data[0]
        new_bought_status = not current_item["is_bought"]
        
        # Update the item
        update_response = supabase.table("grocery_items") \
            .update({"is_bought": new_bought_status}) \
            .eq("item_id", str(item_id)) \
            .eq("user_id", user_id) \
            .execute()
        
        if not update_response.data:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="Failed to toggle item"
            )
        
        return update_response.data[0]
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to toggle item: {str(e)}"
        )


@app.delete("/api/items/{item_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_item(
    item_id: UUID,
    user_id: str = Depends(get_current_user),
    supabase: Client = Depends(get_supabase)
):
    """
    Permanently delete a grocery item.
    This is optional for cleanup - users can keep items indefinitely.
    """
    try:
        response = supabase.table("grocery_items") \
            .delete() \
            .eq("item_id", str(item_id)) \
            .eq("user_id", user_id) \
            .execute()
        
        # Supabase returns data even on delete, but if nothing matched, data is empty
        if not response.data:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Item not found"
            )
        
        return None
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to delete item: {str(e)}"
        )
